<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<link rel="icon" type="image/png" href="assets/img/favicon.ico">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>Light Bootstrap Dashboard by Creative Tim</title>

	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name="viewport" content="width=device-width" />


    <!-- Bootstrap core CSS     -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Animation library for notifications   -->
    <link href="assets/css/animate.min.css" rel="stylesheet"/>

    <!--  Light Bootstrap Table core CSS    -->
    <link href="assets/css/light-bootstrap-dashboard.css" rel="stylesheet"/>


    <!--  CSS for Demo Purpose, don't include it in your project     -->
    <link href="assets/css/style.css" rel="stylesheet" />


    <!--     Fonts and icons     -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
    <link href="assets/css/pe-icon-7-stroke.css" rel="stylesheet" />

    <script type="text/javascript">
        var stops = [
                        {"Geometry":{
                          "Latitude": -8.039963, "Longitude": -34.894049
                        }},
                        {"Geometry":{
                          "Latitude": -8.042326, "Longitude": -34.894448,
                          "Aluno": "Rubens",
                          "Colegio": "",
                          "Data": "07/07/2016",
                          "Hora": "",
                          "Id": 1,
                        }},
                        {"Geometry":{
                          "Latitude": -8.043355,"Longitude": -34.895502,
                          "Aluno": "Basílico",
                          "Colegio": "",
                          "Data": "07/07/2016",
                          "Hora": "",
                          "Id": 2,
                      }},
                        {"Geometry":{
                          "Latitude": -8.044038,"Longitude": -34.894629,
                          "Aluno": "Frodoberto",
                          "Colegio": "",
                          "Data": "07/07/2016",
                          "Hora": "",
                          "Id": 3,
                        }},
                        {"Geometry":{
                          "Latitude": -8.044328,"Longitude": -34.894030,
                          "Aluno": "JPAdmin",
                          "Colegio": "",
                          "Data": "07/07/2016",
                          "Hora": "",
                          "Id": 4,
                        }},
                        {"Geometry":{
                          "Latitude": -8.043505,"Longitude": -34.893372,
                          "Aluno": "Joao Vitor",
                          "Colegio": "",
                          "Data": "07/07/2016",
                          "Hora": "",
                          "Id": 5,
                        }},
                        {"Geometry":{
                          "Latitude": -8.043277,"Longitude": -34.893247,
                          "Aluno": "Iudy",
                          "Colegio": "",
                          "Data": "07/07/2016",
                          "Hora": "",
                          "Id": 6,
                        }},
                        {"Geometry":{
                          "Latitude": -8.042757,"Longitude": -34.892842,
                          "Aluno": "",
                          "Colegio": "Colégio Virtual Vision",
                          "Data": "07/07/2016",
                          "Hora": "",
                          "Id": 7,
                        }},
                        //{"Geometry":{"Latitude": -8.042748, "Longitude": -34.892829}},
                        {"Geometry":{
                          "Latitude": -8.045838, "Longitude": -34.890299,
                          "Aluno": "",
                          "Colegio": "",
                          "Data": "07/07/2016",
                          "Hora": ""
                        }}
                   ];
        
    </script>

</head>
<body>

<div class="wrapper">
    <div class="sidebar" data-color="purple" data-image="assets/img/sidebar-5.jpg">

    <!--   you can change the color of the sidebar using: data-color="blue | azure | green | orange | red | purple" -->


    	<div class="sidebar-wrapper">
            <div class="logo">
                <a href="http://www.creative-tim.com" class="simple-text">
                    Creative Tim
                </a>
            </div>

            <ul class="nav">
                <li>
                    <a href="dashboard.html">
                        <i class="pe-7s-graph"></i>
                        <p>Dashboard</p>
                    </a>
                </li>
                <li>
                    <a href="user.html">
                        <i class="pe-7s-user"></i>
                        <p>User Profile</p>
                    </a>
                </li>
                <li>
                    <a href="table.html">
                        <i class="pe-7s-note2"></i>
                        <p>Table List</p>
                    </a>
                </li>
                <li>
                    <a href="typography.html">
                        <i class="pe-7s-news-paper"></i>
                        <p>Typography</p>
                    </a>
                </li>
                <li>
                    <a href="icons.html">
                        <i class="pe-7s-science"></i>
                        <p>Icons</p>
                    </a>
                </li>
                <li class="active">
                    <a href="maps.html">
                        <i class="pe-7s-map-marker"></i>
                        <p>Maps</p>
                    </a>
                </li>
                <li>
                    <a href="notifications.html">
                        <i class="pe-7s-bell"></i>
                        <p>Notifications</p>
                    </a>
                </li>
            </ul>
    	</div>
    </div>

    <div class="main-panel">
        <nav class="navbar navbar-default navbar-fixed">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navigation-example-2">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">Maps</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-left">
                        <li>
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-dashboard"></i>
                            </a>
                        </li>
                       <li class="dropdown">
                              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="fa fa-globe"></i>
                                    <b class="caret"></b>
                                    <span class="notification">5</span>
                              </a>
                              <ul class="dropdown-menu">
                                <li><a href="#">Notification 1</a></li>
                                <li><a href="#">Notification 2</a></li>
                                <li><a href="#">Notification 3</a></li>
                                <li><a href="#">Notification 4</a></li>
                                <li><a href="#">Another notification</a></li>
                              </ul>
                        </li>
                        <li>
                           <a href="">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                           <a href="">
                               Account
                            </a>
                        </li>
                        <li class="dropdown">
                              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    Dropdown
                                    <b class="caret"></b>
                              </a>
                              <ul class="dropdown-menu">
                                <li><a href="#">Action</a></li>
                                <li><a href="#">Another action</a></li>
                                <li><a href="#">Something</a></li>
                                <li><a href="#">Another action</a></li>
                                <li><a href="#">Something</a></li>
                                <li class="divider"></li>
                                <li><a href="#">Separated link</a></li>
                              </ul>
                        </li>
                        <li>
                            <a href="#">
                                Log out
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="content">
            <div class="container-fluid">
                <div class="card card-map">
                    <div class="header">
                        <h4 class="title">Google Maps</h4>
                        <button class="btn btn-default btn-block" onclick="CalcRota();">Carregar Mapa</button>
                    </div>
                    <div class="map">
                        <div id="map" style="height:800px;"></div>
                    </div>

                    <!-- <button class="btn btn-default btn-block" onclick="filtrando(7);">Filtrar Aluno</button> -->
                    <div class="row">
                        <div class="col-md-12">
                            <input type="search" class="light-table-filter form-control" data-table="order-table" placeholder="Pesquisar...">
                        </div>
                    </div>

                    <div class="row">

                        <div class="col-md-6 gridVV">
                            <h4 class="text-center">Alunos</h4>
                            <table id="tabelaColetas" class="table table-striped table-hover order-table">
                                <thead>
                                    <tr>
                                        <th data-field="hour">Id</th>
                                        <th data-field="name" data-sortable="true">Aluno</th>
                                        <th data-field="date" data-sortable="true">Data</th>
                                        <th data-field="hour">Hora</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaAlunos">

                                </tbody>
                            </table>
                        </div>

                        <div class="col-md-6 gridVV">
                            <h4 class="text-center">Colégios</h4>
                            <!-- <input type="search" class="light-table-filter form-control" data-table="order-table2" placeholder="Pesquisar..."> -->
                            <table id="tabelaColetasColegios" class="table table-striped table-hover order-table">
                                <thead>
                                    <tr>
                                        <th data-field="hour">Id</th>
                                        <th data-field="colegio" data-sortable="true">Colégio</th>
                                        <th data-field="date" data-sortable="true">Data</th>
                                        <th data-field="hour">Hora</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaColegios">

                                </tbody>
                            </table>
                        </div>

                    </div>
                    
                </div>
            </div>
        </div>

    </div>
</div>


</body>

        <!--   Core JS Files   -->
    <script src="assets/js/jquery-1.10.2.js" type="text/javascript"></script>
    <script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
	<script src="assets/js/bootstrap-table.js" type="text/javascript"></script>

	<!--  Checkbox, Radio & Switch Plugins -->
	<script src="assets/js/bootstrap-checkbox-radio-switch.js"></script>

	<!--  Charts Plugin -->
	<script src="assets/js/chartist.min.js"></script>

    <!--  Notifications Plugin    -->
    <script src="assets/js/bootstrap-notify.js"></script>

    <!--  Google Maps Plugin    -->
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>

    <!-- Light Bootstrap Table Core javascript and methods for Demo purpose -->
	<script src="assets/js/light-bootstrap-dashboard.js"></script>


    <script type="text/javascript" src="http://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>

	<!-- Light Bootstrap Table DEMO methods, don't include it in your project! -->
	<script src="assets/js/demo.js"></script>
    <script>

       var gmarkers = [];
        
      function filtrando(id) {

            for (var i=1; i < stops.length;i++){
                while(stops[i].Geometry.Id!=id && i!=0 && i!=stops.length-1){
                    stops.splice(i, 1);
                }
            }


        var map = new window.google.maps.Map(document.getElementById("map"));


        // new up complex objects before passing them around
        var directionsDisplay = new window.google.maps.DirectionsRenderer({suppressMarkers: true});
        var directionsService = new window.google.maps.DirectionsService();

        Tour_startUp(stops);

        window.tour.loadMap(map, directionsDisplay);
        window.tour.fitBounds(map);

        if (stops.length > 1){
            window.tour.calcRoute(directionsService, directionsDisplay);
        }
    }

      function CalcRota() {

        // for (var i=0; i < stops.length;i++){
        //     stops.push(stops[i]);
        // }

        var map = new window.google.maps.Map(document.getElementById("map"));

        // new up complex objects before passing them around
        var directionsDisplay = new window.google.maps.DirectionsRenderer({suppressMarkers: true});
        var directionsService = new window.google.maps.DirectionsService();

        Tour_startUp(stops);

        window.tour.loadMap(map, directionsDisplay);
        window.tour.fitBounds(map);

        if (stops.length > 1){
            window.tour.calcRoute(directionsService, directionsDisplay);
        }
    }

    function Tour_startUp(stops) {
        if (!window.tour) window.tour = {
            updateStops: function (newStops) {
                stops = newStops;
            },
            // map: google map object
            // directionsDisplay: google directionsDisplay object (comes in empty)
            loadMap: function (map, directionsDisplay) {
                var myOptions = {
                    zoom: 13,
                    center: new window.google.maps.LatLng(51.507937, -0.076188), // default to London
                    mapTypeId: window.google.maps.MapTypeId.ROADMAP
                };
                map.setOptions(myOptions);
                directionsDisplay.setMap(map);
            },
            fitBounds: function (map) {
                var bounds = new window.google.maps.LatLngBounds();

                // extend bounds for each record
                jQuery.each(stops, function (key, val) {
                    var myLatlng = new window.google.maps.LatLng(val.Geometry.Latitude, val.Geometry.Longitude);
                    bounds.extend(myLatlng);
                });
                map.fitBounds(bounds);
            },
            calcRoute: function (directionsService, directionsDisplay) {
                var batches = [];
                var itemsPerBatch = 10; // google API max = 10 - 1 start, 1 stop, and 8 waypoints
                var itemsCounter = 0;
                var wayptsExist = stops.length > 0;

                while (wayptsExist) {
                    var subBatch = [];
                    var subitemsCounter = 0;

                    for (var j = itemsCounter; j < stops.length; j++) {
                        subitemsCounter++;
                        subBatch.push({
                            location: new window.google.maps.LatLng(stops[j].Geometry.Latitude, stops[j].Geometry.Longitude),
                            stopover: true
                        });
                        if (subitemsCounter == itemsPerBatch)
                            break;
                    }

                    itemsCounter += subitemsCounter;
                    batches.push(subBatch);
                    wayptsExist = itemsCounter < stops.length;
                    // If it runs again there are still points. Minus 1 before continuing to
                    // start up with end of previous tour leg
                    itemsCounter--;
                }

                // now we should have a 2 dimensional array with a list of a list of waypoints
                var combinedResults;
                var unsortedResults = [{}]; // to hold the counter and the results themselves as they come back, to later sort
                var directionsResultsReturned = 0;

                for (var k = 0; k < batches.length; k++) {
                    var lastIndex = batches[k].length - 1;
                    var start = batches[k][0].location;
                    var end = batches[k][lastIndex].location;

                    // trim first and last entry from array
                    var waypts = [];
                    waypts = batches[k];
                    waypts.splice(0, 1);
                    waypts.splice(waypts.length - 1, 1);

                    var request = {
                        origin: start,
                        destination: end,
                        waypoints: waypts,
                        travelMode: window.google.maps.TravelMode.DRIVING
                    };
                    (function (kk) {
                        directionsService.route(request, function (result, status) {
                            if (status == window.google.maps.DirectionsStatus.OK) {

                                var unsortedResult = { order: kk, result: result };
                                unsortedResults.push(unsortedResult);

                                directionsResultsReturned++;

                                if (directionsResultsReturned == batches.length) // we've received all the results. put to map
                                {
                                    // sort the returned values into their correct order
                                    unsortedResults.sort(function (a, b) { return parseFloat(a.order) - parseFloat(b.order); });
                                    var count = 0;
                                    for (var key in unsortedResults) {
                                        if (unsortedResults[key].result != null) {
                                            if (unsortedResults.hasOwnProperty(key)) {
                                                if (count == 0) // first results. new up the combinedResults object
                                                    combinedResults = unsortedResults[key].result;
                                                else {
                                                    // only building up legs, overview_path, and bounds in my consolidated object. This is not a complete
                                                    // directionResults object, but enough to draw a path on the map, which is all I need
                                                    combinedResults.routes[0].legs = combinedResults.routes[0].legs.concat(unsortedResults[key].result.routes[0].legs);
                                                    combinedResults.routes[0].overview_path = combinedResults.routes[0].overview_path.concat(unsortedResults[key].result.routes[0].overview_path);

                                                    combinedResults.routes[0].bounds = combinedResults.routes[0].bounds.extend(unsortedResults[key].result.routes[0].bounds.getNorthEast());
                                                    combinedResults.routes[0].bounds = combinedResults.routes[0].bounds.extend(unsortedResults[key].result.routes[0].bounds.getSouthWest());
                                                }
                                                count++;
                                            }
                                        }
                                    }
                                    directionsDisplay.setDirections(combinedResults);
                                    var legs = combinedResults.routes[0].legs;
                                    // alert(legs.length);
                                    for (var i=0; i < 1;i++){
                                      var markerletter = "A".charCodeAt(0);
                                      markerletter += i;
                                      markerletter = String.fromCharCode(markerletter);
                                      createMarker(directionsDisplay.getMap(),legs[0].start_location,"Início da Rota","","Rota Iniciada <br>"+legs[i].start_address,"assets/img/marker.png",stops[i].Geometry.Data,stops[i].Geometry.Hora,stops[i].Geometry.Id);
                                    }

                                    for (var i=1; i < legs.length;i++){
                                      var markerletter = "A".charCodeAt(0);
                                      markerletter += i;
                                      markerletter = String.fromCharCode(markerletter);
                                      if (stops[i].Geometry.Aluno!="") {
                                        //createMarker(waypointLocations[i].latlng, pontos[i].Aluno, "Embarcou", "studentIn.png");
                                        createMarker(directionsDisplay.getMap(),legs[i].start_location,stops[i].Geometry.Aluno,"","Aluno embarcou <br>"+legs[i].start_address,"assets/img/studentIn.png",stops[i].Geometry.Data,stops[i].Geometry.Hora,stops[i].Geometry.Id);
                                      }else if(stops[i].Geometry.Colegio!="") {
                                        createMarker(directionsDisplay.getMap(),legs[i].start_location,"",stops[i].Geometry.Colegio,"Rota Iniciada <br>"+legs[i].start_address,"assets/img/colegio.png",stops[i].Geometry.Data,stops[i].Geometry.Hora,stops[i].Geometry.Id);
                                      }
                                    }

                                    var i=legs.length;
                                    var markerletter = "A".charCodeAt(0);
                                    markerletter += i;
                                    markerletter = String.fromCharCode(markerletter);
                                    createMarker(directionsDisplay.getMap(),legs[legs.length-1].end_location,"FIM da Rota","","Rota Finalizada<br>"+legs[legs.length-1].end_address,"assets/img/chegou.png",stops[i].Geometry.Data,stops[i].Geometry.Hora,stops[i].Geometry.Id);

                                }
                            }

                        });
                    })(k);
                }
                showNotificationSucesso('top','center');
            }
        };
    }

    var infowindow = new google.maps.InfoWindow(
      { 
        size: new google.maps.Size(150,50)
      });

    var icons = new Array();
    icons["red"] = new google.maps.MarkerImage("mapIcons/marker_red.png",
          // This marker is 20 pixels wide by 34 pixels tall.
          new google.maps.Size(20, 34),
          // The origin for this image is 0,0.
          new google.maps.Point(0,0),
          // The anchor for this image is at 9,34.
          new google.maps.Point(9, 34));



    function getMarkerImage(iconStr) {
       if ((typeof(iconStr)=="undefined") || (iconStr==null)) { 
          iconStr = "red"; 
       }
       if (!icons[iconStr]) {
          icons[iconStr] = new google.maps.MarkerImage("http://www.google.com/mapfiles/marker"+ iconStr +".png",
          // This marker is 20 pixels wide by 34 pixels tall.
          new google.maps.Size(20, 34),
          // The origin for this image is 0,0.
          new google.maps.Point(0,0),
          // The anchor for this image is at 6,20.
          new google.maps.Point(9, 34));
       } 
       return icons[iconStr];

    }
      // Marker sizes are expressed as a Size of X,Y
      // where the origin of the image (0,0) is located
      // in the top left of the image.
     
      // Origins, anchor positions and coordinates of the marker
      // increase in the X direction to the right and in
      // the Y direction down.

      var iconImage = new google.maps.MarkerImage('mapIcons/marker_red.png',
          // This marker is 20 pixels wide by 34 pixels tall.
          new google.maps.Size(20, 34),
          // The origin for this image is 0,0.
          new google.maps.Point(0,0),
          // The anchor for this image is at 9,34.
          new google.maps.Point(9, 34));
      var iconShadow = new google.maps.MarkerImage('http://www.google.com/mapfiles/shadow50.png',
          // The shadow image is larger in the horizontal dimension
          // while the position and offset are the same as for the main image.
          new google.maps.Size(37, 34),
          new google.maps.Point(0,0),
          new google.maps.Point(9, 34));
          // Shapes define the clickable region of the icon.
          // The type defines an HTML &lt;area&gt; element 'poly' which
          // traces out a polygon as a series of X,Y points. The final
          // coordinate closes the poly by connecting to the first
          // coordinate.
      var iconShape = {
          coord: [9,0,6,1,4,2,2,4,0,8,0,12,1,14,2,16,5,19,7,23,8,26,9,30,9,34,11,34,11,30,12,26,13,24,14,21,16,18,18,16,20,12,20,8,18,4,16,2,15,1,13,0],
          type: 'poly'
      };

    var marcadorAntigo = null; 
    function myclick(i) {
            if(marcadorAntigo!=null && marcadorAntigo !=undefined){
                google.maps.event.trigger(marcadorAntigo, "click");
            }
            google.maps.event.trigger(gmarkers[i], "click");
            marcadorAntigo = gmarkers[i];
        }


    function createMarker(map, latlng, label, colegio, html, url, data, hora, id) {
    // alert("createMarker("+latlng+","+label+","+html+","+color+")");
        var contentString = '<b>'+label+'</b><br>'+html;
        var marker = new google.maps.Marker({
            position: latlng,
            map: map,
            icon: url,
            shadow: iconShadow,
            //icon: getMarkerImage(color),
            shape: iconShape,
            title: label,
            animation: null,
            zIndex: Math.round(latlng.lat()*-100000)<<5
            });
            marker.myname = label;

        google.maps.event.addListener(marker, 'click', function() { 
            
            infowindow.setContent(contentString); 
            infowindow.open(map,marker);
            if (marker.getAnimation() !== null) {
                marker.setAnimation(null);
              } else {
                marker.setAnimation(google.maps.Animation.BOUNCE);
              }
            });

        gmarkers.push(marker);
        // add a line to the side_bar html

        //side_bar_html += '<a href="javascript:myclick(' + (gmarkers.length-1) + ')">' + label + '<\/a><br>';
        if(id!=undefined && colegio==""){
            $("#tabelaAlunos").append(
                                "<tr onclick='myclick(" + (gmarkers.length-1) + ")'>"+
                                        "<td>"+id+"</td>"+
                                        "<td>"+label+"</td>"+
                                        "<td>"+data+"</td>"+
                                        "<td>"+hora+"</td>"+
                                "</tr>");
        }else if(id!=undefined && colegio!=""){
            $("#tabelaColegios").append(
                                "<tr onclick='myclick(" + (gmarkers.length-1) + ")'>"+
                                        "<td>"+id+"</td>"+
                                        "<td>"+colegio+"</td>"+
                                        "<td>"+data+"</td>"+
                                        "<td>"+hora+"</td>"+
                                "</tr>");
        }
        return marker;
    }

    function showNotificationSucesso(from, align){
        color = 2;
        
        $.notify({
            icon: "pe-7s-check",
            message: "Rota carregada com sucesso !"
            
        },{
            type: type[color],
            timer: 4000,
            placement: {
                from: from,
                align: align
            }
        });
    }
        </script>


<!-- TABELA -->
        <script type="text/javascript">

        (function(document) {
            'use strict';

            var LightTableFilter = (function(Arr) {

                var _input;

                function _onInputEvent(e) {
                    _input = e.target;
                    var tables = document.getElementsByClassName(_input.getAttribute('data-table'));
                    Arr.forEach.call(tables, function(table) {
                        Arr.forEach.call(table.tBodies, function(tbody) {
                            Arr.forEach.call(tbody.rows, _filter);
                        });
                    });
                }

                function _filter(row) {
                    var text = row.textContent.toLowerCase(), val = _input.value.toLowerCase();
                    row.style.display = text.indexOf(val) === -1 ? 'none' : 'table-row';
                }

                return {
                    init: function() {
                        var inputs = document.getElementsByClassName('light-table-filter');
                        Arr.forEach.call(inputs, function(input) {
                            input.oninput = _onInputEvent;
                        });
                    }
                };
            })(Array.prototype);

            document.addEventListener('readystatechange', function() {
                if (document.readyState === 'complete') {
                    LightTableFilter.init();
                }
            });

        })(document);
    </script>

</html>
